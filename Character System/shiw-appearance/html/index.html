<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RSG Appearance</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Philosopher:ital,wght@0,400;0,700;1,400;1,700&display=swap');
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --red: #8B0000;
            --red-light: #A52A2A;
            --red-dark: #5C0000;
            --black: #0a0a0a;
            --black-light: #1a1a1a;
            --gray-dark: #2a2a2a;
            --gray: #5a5044;
            --gray-light: #7a6e5d;
            --white: #e0d7c6;
            --white-dim: #b8a88a;
        }

        body {
            font-family: 'Philosopher', 'Times New Roman', Times, serif;
            background: transparent;
            color: var(--white);
            overflow: hidden;
            user-select: none;
        }

        #app {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
        }
        
        #app.visible { display: block; }

        /* ==========================================
           ЛЕВАЯ ПАНЕЛЬ - ГЛАВНОЕ МЕНЮ
           ========================================== */
        .left-panel {
            position: absolute;
            left: 0;
            top: 0;
            width: 320px;
            height: 100vh;
            background: linear-gradient(90deg, rgba(10,10,10,0.98) 0%, rgba(10,10,10,0.95) 80%, rgba(10,10,10,0) 100%);
            display: flex;
            flex-direction: column;
        }

        /* Заголовок */
        .panel-title {
            padding: 40px 25px 20px;
            border-bottom: 1px solid var(--gray-dark);
        }

        .panel-title h1 {
            font-size: 28px;
            font-weight: 700;
            color: var(--white);
            text-transform: uppercase;
            letter-spacing: 4px;
            margin-bottom: 5px;
        }

        .panel-title .subtitle {
            font-size: 14px;
            color: var(--gray-light);
            letter-spacing: 2px;
        }

        /* Красная линия */
        .red-line {
            height: 2px;
            background: linear-gradient(90deg, var(--red) 0%, var(--red-dark) 70%, transparent 100%);
            margin: 0;
        }

        /* Контент меню */
        .menu-content {
            flex: 1;
            overflow-y: auto;
            padding: 10px 0;
        }

        .menu-content::-webkit-scrollbar { width: 3px; }
        .menu-content::-webkit-scrollbar-track { background: var(--black); }
        .menu-content::-webkit-scrollbar-thumb { background: var(--gray-light); }

        /* Секция меню */
        .menu-section {
            padding: 10px 0;
        }

        .menu-section-title {
            font-size: 11px;
            color: var(--gray-light);
            text-transform: uppercase;
            letter-spacing: 2px;
            padding: 10px 25px;
        }

        /* Пункт меню */
        .menu-item {
            display: flex;
            align-items: center;
            padding: 12px 25px;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .menu-item:hover {
            background: rgba(139, 0, 0, 0.15);
        }

        .menu-item.active {
            background: rgba(139, 0, 0, 0.25);
        }

        .menu-item.active::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background: var(--red);
        }

        .menu-icon {
            width: 24px;
            font-size: 16px;
            text-align: center;
            margin-right: 12px;
            color: var(--red);
        }

        .menu-label {
            flex: 1;
            font-size: 16px;
            letter-spacing: 1px;
        }

        .menu-arrow {
            font-size: 12px;
            color: var(--gray-light);
            transition: transform 0.2s ease;
        }

        .menu-item.expanded .menu-arrow {
            transform: rotate(90deg);
        }

        /* Подменю */
        .submenu {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            background: rgba(0,0,0,0.3);
        }

        .submenu.open {
            max-height: 500px;
        }

        .submenu .menu-item {
            padding-left: 50px;
            font-size: 14px;
        }

        /* Футер */
        .panel-footer {
            padding: 15px 25px;
            border-top: 1px solid var(--gray-dark);
        }

        .footer-btns {
            display: flex;
            gap: 10px;
        }

        .btn {
            flex: 1;
            padding: 12px 15px;
            font-family: inherit;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 2px;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-confirm {
            background: var(--red);
            color: var(--white);
        }

        .btn-confirm:hover {
            background: var(--red-light);
        }

        /* Кнопка рандомайзера */
        .btn-random {
            background: var(--gray-dark);
            color: var(--white);
            margin-bottom: 10px;
            width: 100%;
        }

        .btn-random:hover {
            background: var(--red-dark);
        }

        /* ==========================================
           ПРАВАЯ ПАНЕЛЬ - НАСТРОЙКИ
           ========================================== */
        .right-panel {
            position: absolute;
            right: 0;
            top: 0;
            width: 360px;
            height: 100vh;
            background: linear-gradient(270deg, rgba(10,10,10,0.98) 0%, rgba(10,10,10,0.95) 80%, rgba(10,10,10,0) 100%);
            display: none;
            flex-direction: column;
        }

        .right-panel.visible {
            display: flex;
        }

        .settings-header {
            padding: 40px 25px 20px;
            border-bottom: 1px solid var(--gray-dark);
        }

        .settings-header h2 {
            font-size: 22px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 3px;
        }

        .settings-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .settings-content::-webkit-scrollbar { width: 3px; }
        .settings-content::-webkit-scrollbar-track { background: var(--black); }
        .settings-content::-webkit-scrollbar-thumb { background: var(--gray-light); }

        /* Контрол слайдера */
        .control-group {
            margin-bottom: 20px;
        }

        .control-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .control-label .name {
            font-size: 14px;
            color: var(--white-dim);
        }

        .control-label .value {
            font-size: 14px;
            color: var(--red);
            font-weight: 600;
        }

        .slider-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .slider-btn {
            width: 30px;
            height: 30px;
            background: var(--gray-dark);
            border: none;
            color: var(--white);
            font-size: 18px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .slider-btn:hover {
            background: var(--red);
        }

        input[type="range"] {
            flex: 1;
            -webkit-appearance: none;
            height: 4px;
            background: var(--gray-dark);
            border-radius: 2px;
            outline: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            background: var(--red);
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.2);
        }

        /* Выбор пола */
        .gender-selection {
            display: flex;
            gap: 20px;
            padding: 20px;
        }

        .gender-card {
            flex: 1;
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: var(--gray-dark);
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .gender-card:hover {
            border-color: var(--gray);
            background: rgba(139, 0, 0, 0.15);
        }

        .gender-card.selected {
            border-color: var(--red);
            background: rgba(139, 0, 0, 0.25);
        }

        .gender-card .symbol {
            font-size: 48px;
            margin-bottom: 10px;
        }

        .gender-card .gender-label {
            font-size: 16px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        /* Инпут формы */
        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            font-size: 14px;
            color: var(--white-dim);
            margin-bottom: 8px;
        }

        .input-group input,
        .input-group select {
            width: 100%;
            padding: 12px 15px;
            font-family: inherit;
            font-size: 14px;
            background: var(--gray-dark);
            border: 1px solid var(--gray);
            color: var(--white);
            outline: none;
            transition: all 0.2s ease;
        }

        .input-group input:focus,
        .input-group select:focus {
            border-color: var(--red);
        }

        .input-group select {
            cursor: pointer;
        }

        /* Поворот персонажа */
        .rotate-controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            padding: 15px;
            border-top: 1px solid var(--gray-dark);
        }

        .rotate-btn {
            width: 50px;
            height: 50px;
            background: var(--gray-dark);
            border: none;
            color: var(--white);
            font-size: 24px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .rotate-btn:hover {
            background: var(--red);
        }

        /* Камера */
        .camera-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            padding: 15px 20px;
        }

        .camera-btn {
            padding: 12px 20px;
            background: var(--gray-dark);
            border: none;
            color: var(--white);
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 70px;
        }

        .camera-btn:hover, .camera-btn.active {
            background: var(--red);
        }

        /* Подсказки клавиш */
        .controls-hint {
            text-align: center;
            padding: 8px;
            font-size: 11px;
            color: var(--gray-light);
            border-top: 1px solid var(--gray-dark);
        }

        /* Магазин - цена */
        .price-display {
            padding: 15px 25px;
            background: rgba(139, 0, 0, 0.2);
            border-top: 1px solid var(--gray-dark);
        }

        .price-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .price-label {
            font-size: 14px;
            color: var(--white-dim);
        }

        .price-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--red);
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- Левая панель -->
        <div class="left-panel">
            <div class="panel-title">
                <h1 id="main-title">Персонаж</h1>
                <div class="subtitle" id="main-subtitle">Создание</div>
            </div>
            <div class="red-line"></div>
            
            <div class="menu-content" id="menu-container">
                <!-- Меню генерируется JS -->
            </div>
            
            <div class="panel-footer">
                <button class="btn btn-random" id="btn-random" style="display: none;">⚄ Случайная внешность</button>
                <div class="footer-btns">
                    <button class="btn btn-confirm" id="btn-confirm" style="width:100%;">Готово</button>
                </div>
            </div>
        </div>
        
        <!-- Правая панель -->
        <div class="right-panel" id="right-panel">
            <div class="settings-header">
                <h2 id="settings-title">Настройки</h2>
            </div>
            <div class="red-line"></div>
            
            <div class="settings-content" id="settings-container">
                <!-- Настройки генерируются JS -->
            </div>
            
            <div class="camera-controls">
                <button class="camera-btn" onclick="App.moveCamera('up')">▲ Вверх</button>
                <button class="camera-btn" onclick="App.moveCamera('down')">▼ Вниз</button>
                <button class="camera-btn" onclick="App.moveCamera('in')">+ Приблизить</button>
                <button class="camera-btn" onclick="App.moveCamera('out')">- Отдалить</button>
                <button class="camera-btn" onclick="App.moveCamera('reset')">⟲ Вернуть</button>
            </div>
            
            <div class="rotate-controls">
                <button class="rotate-btn" onclick="App.rotatePed('left')">◀</button>
                <button class="rotate-btn" onclick="App.rotatePed('right')">▶</button>
            </div>
            
            <div class="controls-hint">
                A/D - поворот | W/S - камера вверх/вниз
            </div>
            
            <!-- Цена для магазина -->
            <div class="price-display" id="price-display" style="display: none;">
                <div class="price-row">
                    <span class="price-label">Итого:</span>
                    <span class="price-value" id="total-price">$0</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        const App = {
            mode: 'creator', // 'creator' или 'shop'
            isMale: true,
            creatorCache: {},
            clothesCache: {},
            currentCategory: null,
            currentSubmenu: null,
            shopPrices: {},
            totalPrice: 0,

            // Национальности для 1899-1910 Америки
            nationalities: [
                'Американец',
                'Ирландец', 
                'Немец',
                'Итальянец',
                'Мексиканец',
                'Китаец',
                'Афроамериканец',
                'Индеец',
                'Поляк',
                'Швед',
                'Англичанин',
                'Шотландец',
                'Француз',
                'Голландец',
                'Русский'
            ],

            categories: {
                creator: {
                    gender: { 
                        label: 'Пол', 
                        icon: '⚥' 
                    },
                    appearance: {
                        label: 'Внешность',
                        icon: '☺',
                        submenu: {
                            head: { label: 'Голова', controls: [
                                { id: 'head', label: 'Тип головы', min: 2, max: 45, def: 2 },
                                { id: 'skin_tone', label: 'Тон кожи', min: 1, max: 6, def: 1 },
                            ]},
                            body: { label: 'Тело', controls: [
                                { id: 'body_size', label: 'Телосложение', min: 1, max: 5, def: 3 },
                                { id: 'body_waist', label: 'Талия', min: 1, max: 30, def: 11 },
                                { id: 'chest_size', label: 'Грудь', min: 1, max: 11, def: 6 },
                                { id: 'height', label: 'Рост', min: 90, max: 110, def: 100 },
                            ]},
                            face: { label: 'Лицо', controls: [
                                { id: 'head_width', label: 'Ширина головы', min: -100, max: 100, def: 0 },
                                { id: 'face_width', label: 'Ширина лица', min: -100, max: 100, def: 0 },
                                { id: 'jaw_width', label: 'Ширина челюсти', min: -100, max: 100, def: 0 },
                                { id: 'jaw_height', label: 'Высота челюсти', min: -100, max: 100, def: 0 },
                                { id: 'chin_width', label: 'Ширина подбородка', min: -100, max: 100, def: 0 },
                                { id: 'chin_height', label: 'Высота подбородка', min: -100, max: 100, def: 0 },
                                { id: 'chin_depth', label: 'Глубина подбородка', min: -100, max: 100, def: 0 },
                            ]},
                            eyes: { label: 'Глаза', controls: [
                                { id: 'eyes_color', label: 'Цвет глаз', min: 5, max: 18, def: 5 },
                                { id: 'eyes_depth', label: 'Глубина', min: -100, max: 100, def: 0 },
                                { id: 'eyes_angle', label: 'Угол', min: -100, max: 100, def: 0 },
                                { id: 'eyes_distance', label: 'Расстояние', min: -100, max: 100, def: 0 },
                                { id: 'eyes_height', label: 'Высота', min: -100, max: 100, def: 0 },
                                { id: 'eyelid_height', label: 'Высота века', min: -100, max: 100, def: 0 },
                                { id: 'eyelid_width', label: 'Ширина века', min: -100, max: 100, def: 0 },
                            ]},
                            nose: { label: 'Нос', controls: [
                                { id: 'nose_width', label: 'Ширина', min: -100, max: 100, def: 0 },
                                { id: 'nose_size', label: 'Размер', min: -100, max: 100, def: 0 },
                                { id: 'nose_height', label: 'Высота', min: -100, max: 100, def: 0 },
                                { id: 'nose_angle', label: 'Угол', min: -100, max: 100, def: 0 },
                                { id: 'nose_curvature', label: 'Изгиб', min: -100, max: 100, def: 0 },
                                { id: 'nostrils_distance', label: 'Ноздри', min: -100, max: 100, def: 0 },
                            ]},
                            mouth: { label: 'Рот', controls: [
                                { id: 'mouth_width', label: 'Ширина', min: -100, max: 100, def: 0 },
                                { id: 'mouth_depth', label: 'Глубина', min: -100, max: 100, def: 0 },
                                { id: 'mouth_x_pos', label: 'Позиция X', min: -100, max: 100, def: 0 },
                                { id: 'mouth_y_pos', label: 'Позиция Y', min: -100, max: 100, def: 0 },
                                { id: 'upper_lip_height', label: 'Верхняя губа высота', min: -100, max: 100, def: 0 },
                                { id: 'upper_lip_width', label: 'Верхняя губа ширина', min: -100, max: 100, def: 0 },
                                { id: 'lower_lip_height', label: 'Нижняя губа высота', min: -100, max: 100, def: 0 },
                                { id: 'lower_lip_width', label: 'Нижняя губа ширина', min: -100, max: 100, def: 0 },
                            ]},
                            ears: { label: 'Уши', controls: [
                                { id: 'ears_width', label: 'Ширина', min: -100, max: 100, def: 0 },
                                { id: 'ears_height', label: 'Высота', min: -100, max: 100, def: 0 },
                                { id: 'ears_size', label: 'Размер', min: -100, max: 100, def: 0 },
                                { id: 'ears_angle', label: 'Угол', min: -100, max: 100, def: 0 },
                            ]},
                            cheekbones: { label: 'Скулы', controls: [
                                { id: 'cheekbones_width', label: 'Ширина', min: -100, max: 100, def: 0 },
                                { id: 'cheekbones_height', label: 'Высота', min: -100, max: 100, def: 0 },
                                { id: 'cheekbones_depth', label: 'Глубина', min: -100, max: 100, def: 0 },
                            ]},
                            eyebrows: { label: 'Брови', controls: [
                                { id: 'eyebrow_height', label: 'Высота', min: -100, max: 100, def: 0 },
                                { id: 'eyebrow_width', label: 'Ширина', min: -100, max: 100, def: 0 },
                                { id: 'eyebrow_depth', label: 'Глубина', min: -100, max: 100, def: 0 },
                            ]},
                        }
                    },
                    hair: {
                        label: 'Волосы',
                        icon: '✂',
                        controls: [
                            { id: 'hair_model', label: 'Причёска', min: 0, max: 29, def: 0 },
                            { id: 'hair_color', label: 'Цвет волос', min: 1, max: 15, def: 1 },
                            { id: 'beard_model', label: 'Борода', min: 0, max: 50, def: 0, maleOnly: true },
                            { id: 'beard_color', label: 'Стиль Бороды', min: 1, max: 15, def: 1, maleOnly: true },
                        ]
                    },
                    clothes: {
                        label: 'Стартовая одежда',
                        icon: '◈',
                        controls: [
                            { id: 'shirt_model', label: 'Рубашка', min: 0, max: 5, def: 0 },
                            { id: 'pants_model', label: 'Штаны', min: 0, max: 5, def: 0 },
                            { id: 'boots_model', label: 'Обувь', min: 0, max: 5, def: 0 },
                        ]
                    },
                    makeup: {
                        label: 'Особенности',
                        icon: '✦',
                        controls: [
                            { id: 'eyebrows_t', label: 'Брови', min: 1, max: 20, def: 1 },
                            { id: 'eyebrows_op', label: 'Яркость бровей', min: 0, max: 100, def: 100 },
                            { id: 'scars_t', label: 'Шрамы', min: 0, max: 16, def: 0 },
                            { id: 'scars_op', label: 'Яркость шрамов', min: 0, max: 100, def: 100 },
                            { id: 'spots_t', label: 'Пятна', min: 0, max: 16, def: 0 },
                            { id: 'spots_op', label: 'Яркость пятен', min: 0, max: 100, def: 100 },
                            { id: 'moles_t', label: 'Родинки', min: 0, max: 16, def: 0 },
                            { id: 'moles_op', label: 'Яркость родинок', min: 0, max: 100, def: 100 },
                            { id: 'ageing_t', label: 'Старение', min: 0, max: 16, def: 0 },
                            { id: 'ageing_op', label: 'Яркость старения', min: 0, max: 100, def: 100 },
                            { id: 'freckles_t', label: 'Веснушки', min: 0, max: 16, def: 0 },
                            { id: 'freckles_op', label: 'Яркость веснушек', min: 0, max: 100, def: 100 },
                        ]
                    },
                    info: {
                        label: 'Данные',
                        icon: '✎',
                        isInput: true,
                        fields: [
                            { id: 'firstname', label: 'Имя', placeholder: 'Введите имя...', type: 'text' },
                            { id: 'lastname', label: 'Фамилия', placeholder: 'Введите фамилию...', type: 'text' },
                            { id: 'nationality', label: 'Национальность', type: 'select' },
                            { id: 'birthdate', label: 'Дата рождения', placeholder: '01.01.1870', type: 'date' },
                        ]
                    }
                },
                shop: {
                    shirts_full: { label: 'Рубашки', icon: '◈', category: 'shirts_full' },
                    pants: { label: 'Штаны', icon: '◈', category: 'pants' },
                    boots: { label: 'Сапоги', icon: '◈', category: 'boots' },
                    hats: { label: 'Шляпы', icon: '◈', category: 'hats' },
                    coats: { label: 'Пальто', icon: '◈', category: 'coats' },
                    vests: { label: 'Жилеты', icon: '◈', category: 'vests' },
                    gloves: { label: 'Перчатки', icon: '◈', category: 'gloves' },
                    neckwear: { label: 'Шейные украшения', icon: '◈', category: 'neckwear' },
                    eyewear: { label: 'Очки', icon: '◈', category: 'eyewear' },
                    masks: { label: 'Маски', icon: '◈', category: 'masks' },
                    gunbelts: { label: 'Кобуры', icon: '◈', category: 'gunbelts' },
                    suspenders: { label: 'Подтяжки', icon: '◈', category: 'suspenders' },
                    chaps: { label: 'Чапсы', icon: '◈', category: 'chaps' },
                    spurs: { label: 'Шпоры', icon: '◈', category: 'spurs' },
                }
            },

            init() {
                document.getElementById('btn-confirm').onclick = () => this.confirm();
                document.getElementById('btn-random').onclick = () => this.randomize();
                window.addEventListener('message', (e) => this.onMessage(e.data));
            },

            onMessage(data) {
                switch(data.action) {
                    case 'openCreator':
                        this.openCreator(data);
                        break;
                    case 'openShop':
                        this.openShop(data);
                        break;
                    case 'close':
                        this.close();
                        break;
                    case 'setCache':
                        this.creatorCache = data.cache || {};
                        break;
                    case 'updateMax':
                        this.updateSliderMax(data.id, data.max);
                        break;
                    case 'updatePrice':
                        this.updateTotalPrice(data.price);
                        break;
                }
            },

            openCreator(data) {
                this.mode = 'creator';
                this.isMale = data.isMale !== false;
                this.creatorCache = data.cache || {};
                document.getElementById('main-title').textContent = 'Персонаж';
                document.getElementById('main-subtitle').textContent = 'Создание';
                document.getElementById('btn-confirm').textContent = 'Создать';
                document.getElementById('btn-random').style.display = 'block';
                document.getElementById('price-display').style.display = 'none';
                this.renderMenu();
                document.getElementById('app').classList.add('visible');
            },

            openShop(data) {
                this.mode = 'shop';
                this.isMale = data.isMale !== false;
                this.clothesCache = data.cache || {};
                this.shopPrices = data.prices || {};
                document.getElementById('main-title').textContent = 'Магазин';
                document.getElementById('main-subtitle').textContent = 'Одежда';
                document.getElementById('btn-confirm').textContent = 'Купить';
                document.getElementById('btn-random').style.display = 'none';
                document.getElementById('price-display').style.display = 'block';
                this.totalPrice = 0;
                document.getElementById('total-price').textContent = '$0';
                this.renderMenu();
                document.getElementById('app').classList.add('visible');
            },

            close() {
                document.getElementById('app').classList.remove('visible');
                document.getElementById('right-panel').classList.remove('visible');
                this.currentCategory = null;
                this.currentSubmenu = null;
            },

            renderMenu() {
                const container = document.getElementById('menu-container');
                const cats = this.mode === 'creator' ? this.categories.creator : this.categories.shop;
                
                container.innerHTML = '';
                
                for (const [key, cat] of Object.entries(cats)) {
                    const hasSubmenu = cat.submenu && Object.keys(cat.submenu).length > 0;
                    const isActive = this.currentCategory === key;
                    
                    const item = document.createElement('div');
                    item.className = 'menu-item' + (isActive ? ' active' : '') + (hasSubmenu && isActive ? ' expanded' : '');
                    item.innerHTML = `
                        <span class="menu-icon">${cat.icon || '◆'}</span>
                        <span class="menu-label">${cat.label}</span>
                        ${hasSubmenu ? '<span class="menu-arrow">▸</span>' : ''}
                    `;
                    item.onclick = () => this.selectCategory(key);
                    container.appendChild(item);
                    
                    if (hasSubmenu) {
                        const submenu = document.createElement('div');
                        submenu.className = 'submenu' + (isActive ? ' open' : '');
                        
                        for (const [subKey, subCat] of Object.entries(cat.submenu)) {
                            const subItem = document.createElement('div');
                            subItem.className = 'menu-item' + (this.currentSubmenu === subKey ? ' active' : '');
                            subItem.innerHTML = `<span class="menu-label">${subCat.label}</span>`;
                            subItem.onclick = (e) => {
                                e.stopPropagation();
                                this.selectSubmenu(key, subKey);
                            };
                            submenu.appendChild(subItem);
                        }
                        
                        container.appendChild(submenu);
                    }
                }
            },

            selectCategory(key) {
                const cats = this.mode === 'creator' ? this.categories.creator : this.categories.shop;
                const cat = cats[key];
                
                if (!cat) return;
                
                if (this.mode === 'shop') {
                    // В магазине - показываем настройки категории одежды
                    this.currentCategory = key;
                    this.renderMenu();
                    this.renderShopCategory(key, cat);
                    
                    fetch('https://rsg-appearance/selectShopCategory', {
                        method: 'POST',
                        body: JSON.stringify({ category: cat.category || key })
                    });
                } else if (cat.submenu) {
                    const wasOpen = this.currentCategory === key;
                    this.currentCategory = wasOpen ? null : key;
                    this.currentSubmenu = null;
                    this.renderMenu();
                    if (wasOpen) {
                        document.getElementById('right-panel').classList.remove('visible');
                    }
                } else if (key === 'gender') {
                    this.currentCategory = key;
                    this.renderMenu();
                    this.showGenderSelect();
                } else {
                    this.currentCategory = key;
                    this.currentSubmenu = null;
                    this.renderMenu();
                    this.renderSettings(cat);
                }
            },

            selectSubmenu(catKey, subKey) {
                const cats = this.mode === 'creator' ? this.categories.creator : this.categories.shop;
                const sub = cats[catKey]?.submenu?.[subKey];
                
                if (!sub) return;
                
                this.currentSubmenu = subKey;
                this.renderMenu();
                this.renderSettings(sub);
                
                fetch('https://rsg-appearance/selectCategory', {
                    method: 'POST',
                    body: JSON.stringify({ category: subKey })
                });
            },

            showGenderSelect() {
                document.getElementById('right-panel').classList.add('visible');
                document.getElementById('settings-title').textContent = 'Выбор пола';
                
                document.getElementById('settings-container').innerHTML = `
                    <div class="gender-selection">
                        <div class="gender-card ${this.isMale ? 'selected' : ''}" onclick="App.selectGender(true)">
                            <div class="symbol">♂</div>
                            <div class="gender-label">Мужчина</div>
                        </div>
                        <div class="gender-card ${!this.isMale ? 'selected' : ''}" onclick="App.selectGender(false)">
                            <div class="symbol">♀</div>
                            <div class="gender-label">Женщина</div>
                        </div>
                    </div>
                `;
            },

            selectGender(isMale) {
                this.isMale = isMale;
                this.showGenderSelect();
                
                // Обновляем максимум причёсок
                const hairMax = isMale ? 29 : 35;
                this.categories.creator.hair.controls[0].max = hairMax;
                
                fetch('https://rsg-appearance/selectGender', {
                    method: 'POST',
                    body: JSON.stringify({ isMale })
                });
            },

            renderSettings(cat) {
                document.getElementById('right-panel').classList.add('visible');
                document.getElementById('settings-title').textContent = cat.label;
                const container = document.getElementById('settings-container');
                container.innerHTML = '';

                if (cat.isInput) {
                    cat.fields.forEach(field => {
                        const div = document.createElement('div');
                        div.className = 'input-group';
                        
                        if (field.type === 'select' && field.id === 'nationality') {
                            const options = this.nationalities.map(n => 
                                `<option value="${n}">${n}</option>`
                            ).join('');
                            div.innerHTML = `
                                <label>${field.label}</label>
                                <select id="input-${field.id}">
                                    ${options}
                                </select>
                            `;
                        } else if (field.type === 'date') {
                            div.innerHTML = `
                                <label>${field.label}</label>
                                <input type="text" id="input-${field.id}" placeholder="${field.placeholder}" 
                                    maxlength="10" oninput="App.formatDate(this)">
                                <small style="color: var(--gray-light); font-size: 11px;">
                                    Год рождения: 1809-1881
                                </small>
                            `;
                        } else {
                            const isCyrillicField = (field.id === 'firstname' || field.id === 'lastname');
                            div.innerHTML = `
                                <label>${field.label}</label>
                                <input type="text" id="input-${field.id}" placeholder="${field.placeholder || ''}"
                                    ${isCyrillicField ? 'oninput="this.value = this.value.replace(/[^а-яА-ЯёЁ\\s\\-]/g, \'\')"' : ''}>
                                ${isCyrillicField ? '<small style="color: var(--gray-light); font-size: 11px;">Только кириллица</small>' : ''}
                            `;
                        }
                        container.appendChild(div);
                    });
                } else if (cat.controls) {
                    cat.controls.forEach(ctrl => {
                        let minVal = ctrl.min;
                        let maxVal = ctrl.max;
                        let defVal = ctrl.def;
                        
                        // Фильтры для мужчин
                        if (this.isMale) {
                            if (ctrl.id === 'head') {
                                minVal = 2;
                                if (defVal < 2) defVal = 2;
                            } else if (ctrl.id === 'eyes_color') {
                                minVal = 5;
                                if (defVal < 5) defVal = 5;
                            } else if (ctrl.id === 'hair_model') {
                                maxVal = 29;
                            }
                        }
                        
                        // Скрываем maleOnly для женщин
                        if (ctrl.maleOnly && !this.isMale) {
                            return;
                        }
                        
                        const value = this.creatorCache[ctrl.id] ?? defVal;
                        
                        const div = document.createElement('div');
                        div.className = 'control-group';
                        div.innerHTML = `
                            <div class="control-label">
                                <span class="name">${ctrl.label}</span>
                                <span class="value" id="val-${ctrl.id}">${value}</span>
                            </div>
                            <div class="slider-row">
                                <button class="slider-btn" onclick="App.adjust('${ctrl.id}', -1)">−</button>
                                <input type="range" id="slider-${ctrl.id}"
                                    min="${minVal}" max="${maxVal}" value="${value}"
                                    oninput="App.onChange('${ctrl.id}', this.value)">
                                <button class="slider-btn" onclick="App.adjust('${ctrl.id}', 1)">+</button>
                            </div>
                        `;
                        container.appendChild(div);
                    });
                }
            },

            renderShopCategory(key, cat) {
                document.getElementById('right-panel').classList.add('visible');
                document.getElementById('settings-title').textContent = cat.label;
                const container = document.getElementById('settings-container');
                container.innerHTML = '';
                
                const category = cat.category || key;
                const currentData = this.clothesCache[category] || { model: 0, texture: 1 };
                
                // Слайдер модели
                const modelDiv = document.createElement('div');
                modelDiv.className = 'control-group';
                modelDiv.innerHTML = `
                    <div class="control-label">
                        <span class="name">Модель</span>
                        <span class="value" id="val-shop-model">${currentData.model}</span>
                    </div>
                    <div class="slider-row">
                        <button class="slider-btn" onclick="App.adjustShop('model', -1)">−</button>
                        <input type="range" id="slider-shop-model"
                            min="0" max="100" value="${currentData.model}"
                            oninput="App.onShopChange('model', this.value)">
                        <button class="slider-btn" onclick="App.adjustShop('model', 1)">+</button>
                    </div>
                `;
                container.appendChild(modelDiv);
                
                // Слайдер текстуры
                const textureDiv = document.createElement('div');
                textureDiv.className = 'control-group';
                textureDiv.innerHTML = `
                    <div class="control-label">
                        <span class="name">Вариант</span>
                        <span class="value" id="val-shop-texture">${currentData.texture}</span>
                    </div>
                    <div class="slider-row">
                        <button class="slider-btn" onclick="App.adjustShop('texture', -1)">−</button>
                        <input type="range" id="slider-shop-texture"
                            min="1" max="20" value="${currentData.texture}"
                            oninput="App.onShopChange('texture', this.value)">
                        <button class="slider-btn" onclick="App.adjustShop('texture', 1)">+</button>
                    </div>
                `;
                container.appendChild(textureDiv);
                
                // Цена
                const price = this.shopPrices[category] || 0;
                const priceDiv = document.createElement('div');
                priceDiv.className = 'control-group';
                priceDiv.style.marginTop = '20px';
                priceDiv.style.padding = '15px';
                priceDiv.style.background = 'rgba(139,0,0,0.2)';
                priceDiv.innerHTML = `
                    <div style="display: flex; justify-content: space-between;">
                        <span>Цена:</span>
                        <span style="color: var(--red); font-weight: bold;">$${price}</span>
                    </div>
                `;
                container.appendChild(priceDiv);
            },

            onChange(id, value) {
                value = parseInt(value);
                document.getElementById(`val-${id}`).textContent = value;
                this.creatorCache[id] = value;
                
                fetch('https://rsg-appearance/updateValue', {
                    method: 'POST',
                    body: JSON.stringify({ id, value })
                });
            },

            adjust(id, delta) {
                const slider = document.getElementById(`slider-${id}`);
                if (!slider) return;
                
                let value = parseInt(slider.value) + delta;
                value = Math.max(parseInt(slider.min), Math.min(parseInt(slider.max), value));
                
                // Пропускаем битые причёски
                if (id === 'hair_model') {
                    if (this.isMale) {
                        // Для мужчин пропускаем 19
                        while (value === 19 && value >= parseInt(slider.min) && value <= parseInt(slider.max)) {
                            value += delta > 0 ? 1 : -1;
                        }
                    } else {
                        // Для женщин пропускаем 21 и 32
                        const badHairs = [21, 32];
                        while (badHairs.includes(value) && value >= parseInt(slider.min) && value <= parseInt(slider.max)) {
                            value += delta > 0 ? 1 : -1;
                        }
                    }
                    value = Math.max(parseInt(slider.min), Math.min(parseInt(slider.max), value));
                }
                
                slider.value = value;
                this.onChange(id, value);
            },

            onShopChange(type, value) {
                value = parseInt(value);
                document.getElementById(`val-shop-${type}`).textContent = value;
                
                const category = this.currentCategory;
                if (!this.clothesCache[category]) {
                    this.clothesCache[category] = { model: 0, texture: 1 };
                }
                this.clothesCache[category][type] = value;
                
                fetch('https://rsg-appearance/updateShopClothes', {
                    method: 'POST',
                    body: JSON.stringify({ 
                        category: this.categories.shop[category]?.category || category,
                        type, 
                        value 
                    })
                });
            },

            adjustShop(type, delta) {
                const slider = document.getElementById(`slider-shop-${type}`);
                if (!slider) return;
                
                let value = parseInt(slider.value) + delta;
                value = Math.max(parseInt(slider.min), Math.min(parseInt(slider.max), value));
                
                slider.value = value;
                this.onShopChange(type, value);
            },

            updateSliderMax(id, max) {
                const slider = document.getElementById(`slider-${id}`);
                if (slider) slider.max = max;
            },

            updateTotalPrice(price) {
                this.totalPrice = price;
                document.getElementById('total-price').textContent = '$' + price;
            },

            rotatePed(direction) {
                const endpoint = direction === 'left' ? 'rotatePedLeft' : 'rotatePedRight';
                fetch(`https://rsg-appearance/${endpoint}`, { method: 'POST', body: '{}' });
            },

            moveCamera(position) {
                fetch('https://rsg-appearance/moveCamera', { 
                    method: 'POST', 
                    body: JSON.stringify({ position }) 
                });
            },

            formatDate(input) {
                let value = input.value.replace(/\D/g, '');
                if (value.length > 2) {
                    value = value.slice(0, 2) + '.' + value.slice(2);
                }
                if (value.length > 5) {
                    value = value.slice(0, 5) + '.' + value.slice(5, 9);
                }
                input.value = value;
            },

            validateBirthYear(dateStr) {
                const parts = dateStr.split('.');
                if (parts.length !== 3) return false;
                const year = parseInt(parts[2]);
                return year >= 1809 && year <= 1881;
            },

            randomize() {
                fetch('https://rsg-appearance/randomize', { method: 'POST', body: '{}' });
            },

            goBack() {
                if (this.mode === 'shop') {
                    fetch('https://rsg-appearance/exitShop', { method: 'POST', body: '{}' });
                } else {
                    fetch('https://rsg-appearance/cancelCreator', { method: 'POST', body: '{}' });
                }
            },

            confirm() {
                if (this.mode === 'shop') {
                    fetch('https://rsg-appearance/purchaseClothes', { 
                        method: 'POST', 
                        body: JSON.stringify({ cache: this.clothesCache, total: this.totalPrice })
                    });
                } else {
                    const firstname = document.getElementById('input-firstname')?.value || '';
                    const lastname = document.getElementById('input-lastname')?.value || '';
                    const nationality = document.getElementById('input-nationality')?.value || '';
                    const birthdate = document.getElementById('input-birthdate')?.value || '';
                    
                    // Валидация с уведомлениями
                    const cyrillicRegex = /^[а-яА-ЯёЁ\s\-]+$/;
                    
                    if (firstname.length < 2) {
                        this.showNotification('Введите имя (мин. 2 символа)', 'error');
                        return;
                    }
                    if (!cyrillicRegex.test(firstname)) {
                        this.showNotification('Имя должно содержать только кириллицу', 'error');
                        return;
                    }
                    if (lastname.length < 2) {
                        this.showNotification('Введите фамилию (мин. 2 символа)', 'error');
                        return;
                    }
                    if (!cyrillicRegex.test(lastname)) {
                        this.showNotification('Фамилия должна содержать только кириллицу', 'error');
                        return;
                    }
                    if (!nationality) {
                        this.showNotification('Выберите национальность', 'error');
                        return;
                    }
                    if (!this.validateBirthYear(birthdate)) {
                        this.showNotification('Год рождения должен быть между 1809 и 1881', 'error');
                        return;
                    }
                    
                    fetch('https://rsg-appearance/confirmCreator', {
                        method: 'POST',
                        body: JSON.stringify({
                            firstname,
                            lastname, 
                            nationality,
                            birthdate,
                            cache: this.creatorCache
                        })
                    });
                }
            },
            
            showNotification(message, type = 'info') {
                // Создаём уведомление
                const notif = document.createElement('div');
                notif.style.cssText = `
                    position: fixed;
                    top: 20px;
                    left: 50%;
                    transform: translateX(-50%);
                    padding: 15px 30px;
                    background: ${type === 'error' ? 'rgba(139, 0, 0, 0.95)' : 'rgba(0, 100, 0, 0.95)'};
                    color: #f5f5dc;
                    border: 2px solid ${type === 'error' ? '#8B0000' : '#006400'};
                    border-radius: 0;
                    font-family: 'Philosopher', 'Times New Roman', Times, serif;
                    font-size: 18px;
                    z-index: 10000;
                    animation: fadeIn 0.3s ease;
                `;
                notif.textContent = message;
                document.body.appendChild(notif);
                
                setTimeout(() => {
                    notif.style.animation = 'fadeOut 0.3s ease';
                    setTimeout(() => notif.remove(), 300);
                }, 3000);
            }
        };

        App.init();
    </script>
</body>
</html>